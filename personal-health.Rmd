---
title: "Personal Health"
output: 
  html_document:
    code_folding: hide
---

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Cleaning

```{r}
library(tidyverse)
library(lubridate)
library(fable)
library(feasts)
library(tsibble)
library(plotly)
library(here)
library(janitor)
library(highcharter)

theme_set(theme_minimal())
```

```{r}
tar_load(all_totals_ts)
tar_load(all_totals_long_ts)
```

```{r}
duplicates(all_totals_long_ts, index = date, key = Metric)
```

# Univariable Plots Over Time
## Weight

```{r}
hchart(
  all_totals_ts,
  "point",
  hcaes(x = date, y = weight),
  name = "weight",
  showInLegend = TRUE
) %>% 
  hc_add_series(
    all_totals_ts,
    "spline",
    hcaes(x = date, y = daily_7d_avg_weight),
    name = "7d average weight",
    showInLegend = TRUE
  ) %>% 
  hc_title(text = "Weight over time with 7d rolling average")
```


```{r}
weight_plot <- ggplot(all_totals_ts, aes(x = date, y = weight)) +
  geom_point(alpha = 0.3, size = 1.5) +
  scale_x_date(
    date_labels = "%d %b %Y",
    limits = c(as.Date("2019-01-01"), NA)
    ) +
  geom_path(aes(x = date, y = daily_7d_avg_weight)) +
  labs(
    title = "Weight over time with 7d rolling average"
  )

ggplotly(weight_plot)
```

### Autocorrelation
#### Single Values

```{r}
all_totals_ts %>% 
  features(weight, unitroot_kpss)
```

```{r}
all_totals_ts %>% 
  features(weight, unitroot_ndiffs)
```

```{r}
all_totals_ts %>% 
  mutate(weight_diff = difference(weight)) %>% 
  features(weight_diff, unitroot_kpss)
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(weight) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  mutate(weight_diff = difference(weight)) %>% 
  tsibble::fill_gaps() %>% 
  ACF(weight_diff) %>% 
  autoplot()
```

#### Moving Averages


```{r}
all_totals_ts %>% 
  features(daily_7d_avg_weight, unitroot_kpss)
```

```{r}
all_totals_ts %>% 
  features(daily_7d_avg_weight, unitroot_ndiffs)
```

```{r}
all_totals_ts %>% 
  mutate(
    daily_7d_avg_weight_diff = difference(daily_7d_avg_weight)
    ) %>% 
  features(daily_7d_avg_weight_diff, unitroot_kpss)
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(daily_7d_avg_weight) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  mutate(
    daily_7d_avg_weight_diff = difference(daily_7d_avg_weight)
    ) %>% 
  tsibble::fill_gaps() %>% 
  ACF(daily_7d_avg_weight_diff) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  mutate(
    daily_7d_avg_weight_diff = difference(daily_7d_avg_weight)
    ) %>% 
  filter(date > "2020-08-04") %>% 
  autoplot(daily_7d_avg_weight_diff)
```

## Gross Calories

```{r}
calories_plot <- ggplot(all_totals_ts, aes(x = date, y = calories)) +
  geom_point(alpha = 0.3, size = 1.5) +
  scale_x_date(
    date_labels = "%d %b %Y"
    ) +
  geom_line(aes(x = date, y = daily_7d_avg_calories), color = "black") +
  geom_path(aes(x = date, y = bmr_mifflin_st_joer), color = "dodgerblue") +
  labs(
    title = "Gross calories over time with 7d rolling average"
  )

ggplotly(calories_plot)
```

### Autocorrelation
#### Single Values

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(calories) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(daily_7d_avg_calories) %>% 
  autoplot()
```

#### Moving Averages

## Net Calories

```{r}
net_calories_plot <- ggplot(all_totals_ts, aes(x = date, y = net_calories)) +
  geom_point(alpha = 0.3, size = 1.5) +
  scale_x_date(
    date_labels = "%d %b %Y",
    ) +
  geom_line(aes(x = date, y = daily_7d_avg_net_calories), color = "black") +
  geom_path(aes(x = date, y = bmr_mifflin_st_joer), color = "dodgerblue") +
  labs(
    title = "Net calories over time with 7d rolling average"
  )

ggplotly(net_calories_plot)
```

### Autocorrelation
#### Single Values

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(net_calories) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(daily_7d_avg_net_calories) %>% 
  autoplot()
```

#### Moving Averages

## Calorie Delta

```{r}
calorie_delta_plot <- ggplot(all_totals_ts, aes(x = date, y = calorie_delta)) +
  geom_point(alpha = 0.3, size = 1.5) +
  scale_x_date(
    date_labels = "%d %b %Y",
    limits = c(as.Date("2019-05-01"), NA)
    ) +
  geom_line(aes(x = date, y = daily_7d_avg_calorie_delta), color = "black") +
  labs(
    title = "Gross calories over time with 7d rolling average"
  )

ggplotly(calorie_delta_plot)
```

### Autocorrelation
#### Single Values

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(calorie_delta) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  ACF(daily_7d_avg_calorie_delta) %>% 
  autoplot()
```

#### Moving Averages



# Regression
## Weight vs Gross Calories

```{r}
all_totals_ts %>%   
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  ggplot(aes(x = calories, y = weight)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  model(TSLM(weight ~ calories)) %>% 
  report()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  CCF(calories, weight) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  CCF(daily_7d_avg_calories, daily_7d_avg_weight) %>% 
  autoplot()
```

## Weight vs Net Calories


```{r}
all_totals_ts %>%   
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  ggplot(aes(x = net_calories, y = weight)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  model(TSLM(weight ~ net_calories)) %>% 
  report()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  CCF(net_calories, weight) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  CCF(daily_7d_avg_net_calories, daily_7d_avg_weight) %>% 
  autoplot()
```

## Weight vs Calorie Delta


```{r}
all_totals_ts %>%   
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  ggplot(aes(x = calorie_delta, y = weight)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  model(TSLM(weight ~ calorie_delta)) %>% 
  report()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  tsibble::fill_gaps() %>% 
  CCF(calorie_delta, weight) %>% 
  autoplot()
```

```{r}
all_totals_ts %>% 
  filter(date > "2020-08-04" & date < "2021-01-03") %>% 
  CCF(daily_7d_avg_calorie_delta, daily_7d_avg_weight) %>% 
  autoplot()
```
